---
title: "Using scPNMF to perform dimensionality reduction, informative gene selection and new data projection"
author: "Dongyuan Song, Kexin Li"
date: "`r BiocStyle::doc_date()`"
output: 
  BiocStyle::html_document:
    highlight: pygments
    toc: true
    fig_width: 6
    fig_height: 3
vignette: >
  %\VignetteIndexEntry{scPNMF}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo=FALSE, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE, cache = TRUE, dev = "png",
                      message = FALSE, error = FALSE, warning = TRUE)
```

# Introduction 

```{r setup}
suppressPackageStartupMessages(library(scPNMF))
suppressPackageStartupMessages(library(SingleCellExperiment))
suppressPackageStartupMessages(library(umap))
suppressPackageStartupMessages(library(ggplot2))
```


# Setting up the data

```{r load-data}
data(zheng4, package = "scPNMF")
Input_zheng4 <- logcounts(zheng4)
```




# Step I: PNMF

```{r PNMF}
res_pnmf <- scPNMF::PNMFfun(X = Input_zheng4,
                            K = 10, method="EucDist", tol=1e-4, maxIter=1000, verboseN = TRUE)
W <- res_pnmf$Weight
S <- res_pnmf$Score
```





# Step II: basis selection

### 1. Functional annotations
```{r annotation}
res_annotation <- scPNMF::basisAnnotate(W = W, 
                                        dim_use = 1:10,
                                        id_type = "ENSEMBL",
                                        return_fig = TRUE)
plot(res_annotation$p_comp)
```

### 2. Data-driven strategies (correlations with cell library sizes and multimodality tests)
```{r tests}
res_test <- scPNMF::basisTest(S, X=Input_zheng4,
                              return_fig = TRUE,
                              mc.cores = 1)
res_test$fig
```


### Combined basis selection function
```{r basisselect}
W_select <- scPNMF::basisSelect(W, S, X=Input_zheng4, toTest = TRUE, toAnnotate = FALSE, mc.cores = 1)
colnames(W_select)
```




# Application I: dimensionality reduction
```{r umap}
S_select <- t(Input_zheng4) %*% W_select
cell_type <- colData(zheng4)$phenoid
umap_select <- data.frame(umap(S_select)$layout, cell_type)
colnames(umap_select) <- c("UMAP1", "UMAP2", "cell_type")

ggplot(umap_select, aes(x=UMAP1, y=UMAP2)) + geom_point(size=0.1, alpha=1, aes(color=cell_type)) +
  ggtitle("UMAP Plot") + theme_bw() +
  theme(aspect.ratio=1, plot.title = element_text(face = "bold", size=12, hjust = 0.5), legend.position = "bottom") +
  guides(color = guide_legend(override.aes = list(size=5)))
```



# Application II: informative gene selection 
```{r infogene}
ig <- getInfoGene(W_select, M = 100, by_basis = FALSE, return_trunW = TRUE, dim_use = NULL)
print(ig$InfoGene)
```




# Application III: new data projection
```{r projection}
getProjection(Input_zheng4, ig$trunW)
```




# Getting help




# Session information




# References




